<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ByteMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navbar -->
    <div class="bg-white shadow-md">
        <div class="px-4 py-4 flex items-center">
            <h1 class="text-3xl font-bold ml-[5px]">ByteMe</h1>
        </div>
    </div>

    <div class="px-4 py-8">
        <div class="flex gap-4">
            <!-- Left Column (15% width) -->
            <div class="w-1/6 bg-white p-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Select Template:</label>
                    <select id="templateSelect" class="w-full p-2 border rounded-lg">
                        <option value="basic">Basic ML Pipeline</option>
                        <option value="custom">Custom Code</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Upload CSV:</label>
                    <div class="relative">
                        <input type="file" id="csvUpload" accept=".csv" class="hidden">
                        <label for="csvUpload" class="w-full p-2 border rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 text-center block">
                            Choose File
                        </label>
                        <div id="fileName" class="text-sm text-gray-500 mt-1 truncate"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column (flex-1) -->
            <div class="flex-1 relative">
                <div id="editor" class="h-[calc(100vh-12rem)] border border-gray-300 rounded-lg"></div>
            </div>
        </div>

        <!-- Floating Buttons -->
        <div class="fixed bottom-8 right-8 flex gap-4">
            <button id="showOutputButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">
                Show Output
            </button>
            <button id="runButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">
                Run Code
            </button>
        </div>

        <!-- Status Indicator -->
        <div id="status" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 text-gray-600 bg-white px-4 py-2 rounded-lg shadow flex items-center gap-2">
            <div id="spinner" class="hidden">
                <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <span id="statusText"></span>
            <span id="timer" class="text-sm text-gray-500"></span>
        </div>

        <!-- Output Modal -->
        <div id="outputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3/4 h-3/4 bg-white rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Output</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="output" class="bg-gray-800 text-green-400 p-4 rounded-lg font-mono h-[calc(100%-4rem)] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            const editor = monaco.editor.create(document.getElementById('editor'), {
                value: `# Basic ML Pipeline Template
# 1. Data Fetching
data = data_fetch('path/to/your/data.csv')

# 2. Data Preprocessing
X_train, X_test, y_train, y_test, scaler = data_preprocessing(
    data=data,
    target_column='target',
    test_size=0.2
)

# 3. Model Training
model = train(
    X_train=X_train,
    y_train=y_train,
    model_type='linear'  # Options: 'linear', 'random_forest', 'neural_network'
)

# 4. Model Evaluation
from sklearn.metrics import mean_squared_error
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
print(f"Mean Squared Error: {mse}")`,
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true
            });

            const outputDiv = document.getElementById('output');
            const statusDiv = document.getElementById('status');
            const runButton = document.getElementById('runButton');
            const showOutputButton = document.getElementById('showOutputButton');
            const outputModal = document.getElementById('outputModal');
            const closeModal = document.getElementById('closeModal');
            const templateSelect = document.getElementById('templateSelect');
            const csvUpload = document.getElementById('csvUpload');
            const fileName = document.getElementById('fileName');

            const templates = {
                basic: `# Basic ML Pipeline Template
# 1. Data Fetching
data = data_fetch('path/to/your/data.csv')

# 2. Data Preprocessing
X_train, X_test, y_train, y_test, scaler = data_preprocessing(
    data=data,
    target_column='target',
    test_size=0.2
)

# 3. Model Training
model = train(
    X_train=X_train,
    y_train=y_train,
    model_type='linear'  # Options: 'linear', 'random_forest', 'neural_network'
)

# 4. Model Evaluation
from sklearn.metrics import mean_squared_error
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
print(f"Mean Squared Error: {mse}")`,
                custom: `# Enter your custom code here
# Available functions:
# - data_fetch(data_path)
# - data_preprocessing(data, target_column=None, test_size=0.2)
# - train(X_train, y_train, model_type='linear', **kwargs)

print("Hello, World!")`
            };

            templateSelect.addEventListener('change', (e) => {
                editor.setValue(templates[e.target.value]);
            });

            async function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }

                    const result = await response.json();
                    if (result.status === 'success') {
                        // Update the code to use the uploaded file
                        const code = editor.getValue();
                        const updatedCode = code.replace(
                            /data_fetch\(.*\)/,
                            `data_fetch('${result.filename}')`
                        );
                        editor.setValue(updatedCode);
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload file: ' + error.message);
                }
            }

            csvUpload.addEventListener('change', handleFileUpload);

            let ws = null;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 2000; // 2 seconds
            let executionStartTime = null;
            let timerInterval = null;

            function updateTimer() {
                if (executionStartTime) {
                    const elapsed = Math.floor((Date.now() - executionStartTime) / 1000);
                    document.getElementById('timer').textContent = `(${elapsed}s)`;
                }
            }

            function startTimer() {
                executionStartTime = Date.now();
                document.getElementById('timer').textContent = '(0s)';
                timerInterval = setInterval(updateTimer, 1000);
            }

            function stopTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                executionStartTime = null;
                document.getElementById('timer').textContent = '';
            }

            function updateStatus(message, showSpinner = false) {
                document.getElementById('statusText').textContent = message;
                document.getElementById('spinner').classList.toggle('hidden', !showSpinner);
            }

            function connectWebSocket() {
                if (ws) {
                    try {
                        ws.close();
                    } catch (e) {
                        console.error('Error closing existing connection:', e);
                    }
                }

                ws = new WebSocket(`ws://${window.location.host}/ws`);
                
                ws.onopen = function() {
                    console.log('WebSocket connection established');
                    updateStatus('Connected to server');
                    reconnectAttempts = 0;
                };

                ws.onclose = function() {
                    console.log('WebSocket connection closed');
                    updateStatus('Disconnected from server');
                    stopTimer();
                    
                    // Attempt to reconnect
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        updateStatus(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                        setTimeout(connectWebSocket, reconnectDelay);
                    } else {
                        updateStatus('Failed to connect to server. Please refresh the page.');
                    }
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateStatus('Connection error');
                };

                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'status') {
                        if (data.status === 'running') {
                            updateStatus(data.message, true);
                        } else if (data.status === 'error') {
                            updateStatus(data.message);
                            stopTimer();
                        } else {
                            updateStatus(data.message);
                        }
                        if (data.status === 'running' || data.status === 'error') {
                            outputDiv.textContent += '\n' + data.message;
                        }
                    } else if (data.type === 'output') {
                        outputDiv.textContent += '\n' + data.result;
                        outputModal.classList.remove('hidden');
                        stopTimer();
                    }
                    
                    // Scroll to bottom of output
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                };
            }

            // Initial connection when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                connectWebSocket();
            });

            runButton.addEventListener('click', () => {
                const code = editor.getValue();
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    statusDiv.textContent = 'Not connected to server. Attempting to reconnect...';
                    connectWebSocket();
                    // Wait a bit for the connection to establish
                    setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            sendCode(code);
                        } else {
                            statusDiv.textContent = 'Failed to connect to server. Please refresh the page.';
                        }
                    }, 1000);
                } else {
                    sendCode(code);
                }
            });

            function sendCode(code) {
                // Clear previous output
                outputDiv.textContent = '';
                // Show output modal
                outputModal.classList.remove('hidden');
                
                ws.send(JSON.stringify({
                    code: code,
                    timestamp: new Date().toISOString()
                }));
                updateStatus('Executing code...', true);
                startTimer();
            }

            showOutputButton.addEventListener('click', () => {
                outputModal.classList.remove('hidden');
            });

            closeModal.addEventListener('click', () => {
                outputModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            outputModal.addEventListener('click', (e) => {
                if (e.target === outputModal) {
                    outputModal.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html> 